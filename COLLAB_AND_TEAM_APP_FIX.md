# Исправление: Отправка сообщений от NPC на коллабы и заявки в команду

## Проблема
Сообщения от NPC приходили в мессенджер несправедливо — иногда пачками и по несколько раз. Это происходило потому, что:
1. После обработки ответов на предложения коллаба не очищались флаги `pendingCollabs`
2. Флаги `pendingCollabs` остаются в `player` состоянии навсегда
3. Кнопка "Предложить коллаб" остается в состоянии "отправлено" даже после получения ответа

## Решение

### Изменение 1: Добавление `npcName` в сообщение коллаба (GameContext.tsx)
**Файл**: `game/src/context/GameContext.tsx`  
**Строка**: 2490  

Добавлено поле `npcName` для консистентности с другими типами сообщений:

```typescript
setInbox(prev => [{
  id: `collab_res_${proposal.id}`,
  type: 'collab_response',
  npcId: proposal.npcId,
  npcName: npc.name,  // ← ДОБАВЛЕНО
  senderId: proposal.npcId,
  text: message,
  accepted,
  absDay: newAbsDay,
  read: false
}, ...prev]);
```

### Изменение 2: Очистка флагов `pendingCollabs` (GameContext.tsx)
**Файл**: `game/src/context/GameContext.tsx`  
**Строка**: 2500-2510  

После обработки ответов на предложения коллаба теперь очищаются флаги `pendingCollabs` из состояния игрока:

```typescript
// Mark proposals as attempted (so we don't re-process them)
setQueuedCollabProposals(prev => prev.map(q => ready.some(r => r.id === q.id) ? { ...q, attempted: true } : q));

// Clear pendingCollabs flags for NPCs that have received a response
try {
  const respondedNpcIds = ready.map(r => r.npcId);
  setState(prev => {
    const prevPending = (prev.player.pendingCollabs || {});
    const updatedPending = Object.fromEntries(Object.entries(prevPending).filter(([k]) => !respondedNpcIds.includes(k)));
    return { ...prev, player: { ...prev.player, pendingCollabs: updatedPending } };
  });
} catch (e) { /* ignore */ }
```

## Как это работает

### Для ответов на коллабы:
1. **День 1**: Игрок нажимает "Предложить коллаб" → `pendingCollabs[npcId] = true` (кнопка становится неактивной)
2. **День 1**: Предложение добавляется в `queuedCollabProposals` с `respondAbsDay = текущий день + 1-7 дней`
3. **Через 1-7 дней**: При advance day проверяется `queuedCollabProposals`
4. **Ответ NPC**: 
   - Вероятность принятия зависит от количества прошедших дней:
     - Дни 1-5: 70% шанс
     - Дни 6-10: 50% шанс
     - Дни 11-15: 30% шанс
     - Дни 16+: 10% шанс
   - Сообщение добавляется в `inbox` с типом `collab_response`
   - Флаг `attempted` устанавливается в `true`
   - **Флаг `pendingCollabs[npcId]` удаляется из состояния игрока**
5. **Мессенджер**: Сообщение отображается в чате с NPC, кнопка "Предложить коллаб" становится активной снова

### Для ответов на заявки в команду:
1. **День 1**: Игрок нажимает "Подать заявку" → `pendingApplication` устанавливается в состоянии команды
2. **День 1**: Заявка добавляется в `queuedApplications` с `reviewAbsDay = текущий день + 1-7 дней`
3. **Через 1-7 дней**: При advance day проверяется `queuedApplications`
4. **Ответ команды**:
   - Компаратор навыков: сравнивается навык игрока с средним навыком команды
   - Если разница > 18, заявка отклоняется
   - Если разница ≤ 18, заявка принимается и игрок присоединяется к команде
   - Сообщение добавляется в `inbox` с типом `team_application`
   - **Флаг `pendingApplication` удаляется из состояния команды**
5. **Мессенджер**: Сообщение отображается как сообщение от лидера команды, кнопка "Подать заявку" становится активной снова

## Тестирование

1. **Отправьте предложение коллаба**:
   - Откройте NPC Profile
   - Нажмите "Предложить коллаб"
   - Кнопка должна стать неактивной с текстом "Предложение отправлено"
   - В мессенджере NPC должен появиться/обновиться

2. **Подождите 1-7 дней** (дни обновляются при смене режима "Управление" или в скриптах)

3. **Проверьте ответ**:
   - Откройте мессенджер и найдите чат с NPC
   - Должно быть сообщение вроде "Сакура согласилась на совместный проект!" или "Сакура отказалась от совместного проекта."
   - Кнопка "Предложить коллаб" в профиле NPC должна снова стать активной

4. **Отправьте заявку в команду**:
   - Откройте профиль команды
   - Нажмите "Подать заявку"
   - Кнопка должна стать неактивной

5. **Подождите 1-7 дней**

6. **Проверьте ответ**:
   - Откройте мессенджер
   - Должно быть сообщение вроде "Ваша заявка в команду Dragon принята!" или отклонена
   - Кнопка "Подать заявку" должна снова стать активной

## Отличия от старой версии (kpop 1.6 true)

| Параметр | Старая версия | Новая версия |
|----------|---|---|
| Обработка коллабов | В useEffect | В advanceDay (правильно!) |
| Очистка `pendingCollabs` | ✓ Присутствует | ✓ ДОБАВЛЕНО |
| `npcName` в ответе | ✓ Присутствует | ✓ ДОБАВЛЕНО |
| Обработка заявок | В useEffect | В advanceDay (правильно!) |
| `npcId` для команды | ✗ Используется `team.id` | ✓ Используется `team.leaderId` |
| Очистка флагов команды | ✓ Присутствует | ✓ Присутствует |

## Результат

После этого исправления:
- ✅ Сообщения от NPC приходят только один раз
- ✅ Флаги `pendingCollabs` и `pendingApplication` очищаются после получения ответа
- ✅ Кнопки "Предложить коллаб" и "Подать заявку" становятся активными снова после ответа
- ✅ Логика синхронизирована между мессенджером и профилем NPC/команды
