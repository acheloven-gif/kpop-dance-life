# Сравнение логики между версиями

## Основные различия между kpop 1.4 (старая) и kpop 1.6 true (новая), которые были успешно перенесены

### 1. Обработка ответов на предложения коллаба

**Старая логика (неработала)**: В useEffect  
**Новая логика (работает)**: В advanceDay

**Что было исправлено в текущей версии (kpop 1.4)**:
- ✅ Ответы теперь обрабатываются в правильном месте (advanceDay)
- ✅ Добавлено поле `npcName` в сообщение коллаба
- ✅ **НОВОЕ**: Добавлена очистка флагов `pendingCollabs` после получения ответа

**Код (GameContext.tsx, строки 2500-2510)**:
```typescript
// Clear pendingCollabs flags for NPCs that have received a response
try {
  const respondedNpcIds = ready.map(r => r.npcId);
  setState(prev => {
    const prevPending = (prev.player.pendingCollabs || {});
    const updatedPending = Object.fromEntries(
      Object.entries(prevPending).filter(([k]) => !respondedNpcIds.includes(k))
    );
    return { ...prev, player: { ...prev.player, pendingCollabs: updatedPending } };
  });
} catch (e) { /* ignore */ }
```

### 2. Обработка ответов на заявки в команду

**Логика**: Заявки обрабатываются в advanceDay  
**Статус**: ✅ Уже правильно реализовано (очищает `pendingApplication`)

### 3. Вероятность принятия коллаба

**Модель**:
- Дни 1-5: 70% шанс
- Дни 6-10: 50% шанс
- Дни 11-15: 30% шанс
- Дни 16+: 10% шанс

**Статус**: ✅ Уже правильно реализовано

## Почему было много повторных сообщений?

1. **Флаги не очищались**: `pendingCollabs[npcId]` оставался в состоянии навсегда
2. **Тройная обработка**: Сообщение могло обрабатываться несколько раз из-за:
   - Отсутствия проверки `attempted: false`
   - Отсутствия очистки флагов
   - Re-render компонентов вызывающих setInbox несколько раз

## Решение

1. **Добавлена очистка флагов** в advanceDay после обработки каждого ответа коллаба
2. **Проверка `attempted: false`** уже присутствовала в фильтре
3. **Данные обновляются правильно** через ref для актуальности в замыкании

## Результат

После применения исправления:
- ✅ Ответы приходят ровно один раз
- ✅ Флаги корректно очищаются
- ✅ Кнопки активируются/деактивируются правильно
- ✅ Поведение синхронизировано между всеми компонентами
